{% extends "base.html" %}

{% block title %}Scan for Duplicates{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/scan.css') }}">
<script>
    let isScanning = false;
    let pollingInterval = null;
    let cancelRequested = false;

    function resetScanUI() {
        const progressBarInner = document.getElementById("progress-bar-inner");
        const progressText = document.getElementById("progress-text");
        progressBarInner.style.width = "0%";
        progressText.textContent = "0% Complete";

        const summaryContainer = document.getElementById("scan-summary");
        summaryContainer.style.display = "none";

        document.getElementById("total-duplicates").textContent = "";
        document.getElementById("total-size").textContent = "";
        document.getElementById("time-taken").textContent = "";
        document.getElementById("time-completed").textContent = "";

        const driveSummaryTable = document.getElementById("drive-summary-table").querySelector("tbody");
        driveSummaryTable.innerHTML = "";

        document.getElementById("cancel-button").style.display = "none";
    }

    function formatNumberWithCommas(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function resetScanState() {
        cancelRequested = false;
        isScanning = false;
        const submitButton = document.querySelector(".btn.btn-primary");
        submitButton.disabled = false;

        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
    }

    function waitForSummary() {
        // Only stop if explicitly canceled
        if (cancelRequested) {
            console.log("⏹️ Polling stopped: scan was canceled.");
            return;
        }

        fetch("/scan-summary")
            .then(res => {
                if (res.status === 202) {
                document.getElementById("progress-text").textContent = "Finalizing summary...";
                setTimeout(waitForSummary, 500);
                return null;  // ❗ This only works *inside a .then() callback function*
            }
                return res.json();
            })
            .then(summary => {
                if (!summary) return;

                if (summary.error) {
                    console.error("❌ Summary contains error:", summary.error);
                    resetScanState();
                    resetScanUI();
                    document.getElementById("cancel-button").style.display = "none";
                    return;
                }

                console.log("📦 Scan summary received:", summary);
                updateSummary(summary);
                resetScanState();
                document.getElementById("cancel-button").style.display = "none";
            })
            .catch(error => {
                console.error("⚠️ Error fetching scan summary:", error);
                if (isScanning) {
                    setTimeout(waitForSummary, 1000);
                }
            });
    }

    function updateDrives() {
        const sourceChoice = document.getElementById("source_choice").value;
        const drivesField = document.getElementById("drives");
        drivesField.innerHTML = "";
        fetch(`/get_drives/${sourceChoice}`)
            .then(response => response.json())
            .then(data => {
                data.drives.forEach(drive => {
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.name = "drives";
                    checkbox.value = drive;
                    checkbox.id = `drive-${drive}`;

                    const label = document.createElement("label");
                    label.htmlFor = `drive-${drive}`;
                    label.textContent = drive;

                    const container = document.createElement("div");
                    container.className = "form-check";
                    container.appendChild(label);
                    container.appendChild(checkbox);

                    drivesField.appendChild(container);
                });
            })
            .catch(error => console.error("Error fetching drives:", error));
    }

    function cancelScan() {
        cancelRequested = true;
        fetch("/cancel_scan", { method: "POST" })
            .then(response => {
                if (response.ok) {
                    console.log("🚫 Scan canceled.");
                    resetScanState();
                    resetScanUI();
                    // 👇 Hide the progress bar completely
                    document.getElementById("progress-container").style.display = "none";
                } else {
                    console.error("Failed to cancel scan.");
                }
            })
            .catch(error => {
                console.error("Error canceling scan:", error);
            });
    }

    function startProgress() {
        const progressContainer = document.getElementById("progress-container");
        const progressBarInner = document.getElementById("progress-bar-inner");
        const progressText = document.getElementById("progress-text");
        const submitButton = document.querySelector(".btn.btn-primary");
        const cancelButton = document.getElementById("cancel-button");
        const form = document.querySelector("form");

        resetScanState();
        resetScanUI();

        isScanning = true;
        submitButton.disabled = true;
        cancelButton.style.display = "inline-block";
        progressContainer.style.display = "block";

        const formData = new FormData(form);

        fetch("/start_scan", {
            method: "POST",
            body: formData
        }).then(response => {
            if (response.ok) {
                updateProgress();
            } else {
                console.error("Failed to start scan.");
                resetScanState();
            }
        }).catch(error => {
            console.error("Error starting scan:", error);
            resetScanState();
        });

        function updateProgress() {
            fetch("/progress")
                .then(response => response.json())
                .then(data => {
                    const progress = data.progress;
                    progressBarInner.style.width = progress + "%";
                    progressText.textContent = progress + "% Complete";

                    if (progress < 100) {
                        setTimeout(updateProgress, 500);
                    } else {
                        waitForSummary();
                    }
                })
                .catch(error => {
                    console.error("Error updating progress:", error);
                    resetScanState();
                });
        }
    }

    function updateSummary(summary) {
        const summaryContainer = document.getElementById("scan-summary");
        summaryContainer.style.display = "block";

        document.getElementById("total-duplicates").textContent = summary.total_duplicates || "0";
        document.getElementById("total-size").textContent = summary.total_duplicate_size || "0.00 MB";
        document.getElementById("time-taken").textContent = summary.time_taken
            ? summary.time_taken.toFixed(2) + " seconds"
            : "N/A";
        document.getElementById("time-completed").textContent = summary.time_completed || "N/A";

        const driveSummaryContainer = document.getElementById("drive-summary-container");
        const driveSummaryTable = document.getElementById("drive-summary-table").querySelector("tbody");
        driveSummaryTable.innerHTML = "";

        // Remove any existing no-duplicates message from prior scans
        const existingMessage = document.getElementById("no-duplicates-message");
        if (existingMessage) {
            existingMessage.remove();
        }

        if (!summary.drive_summary || Object.keys(summary.drive_summary).length === 0) {
            // Hide the table
            driveSummaryContainer.style.display = "none";

            // Show a standalone message
            const message = document.createElement("p");
            message.id = "no-duplicates-message";
            message.style.marginTop = "1rem";
            message.style.fontWeight = "bold";
            message.textContent = "✅ No duplicate files found.";
            summaryContainer.appendChild(message);
            return;
        } else {
            // Show the table again if there are duplicates
            driveSummaryContainer.style.display = "block";
        }

        for (const [drive, data] of Object.entries(summary.drive_summary)) {
            const row = document.createElement("tr");

            const driveCell = document.createElement("td");
            driveCell.textContent = drive;

            const fileCountCell = document.createElement("td");
            const rawCount = typeof data.file_count === "number"
                ? data.file_count
                : parseInt((data.file_count || "0").replace(/,/g, ""));
            fileCountCell.textContent = formatNumberWithCommas(rawCount);

            const totalSizeCell = document.createElement("td");
            totalSizeCell.textContent = data.total_size || "0.00 MB";

            [driveCell, fileCountCell, totalSizeCell].forEach(cell => {
                cell.style.border = "1px solid #ddd";
                cell.style.padding = "8px";
                row.appendChild(cell);
            });

            driveSummaryTable.appendChild(row);
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        updateDrives();
        const form = document.querySelector("form");
        form.addEventListener("submit", (event) => {
            event.preventDefault();
            if (!isScanning) {
                startProgress();
            }
        });

        document.getElementById("cancel-button").addEventListener("click", cancelScan);
    });

</script>
{% endblock %}

{% block content %}
<a href="/" class="back-button">Back to Main Menu</a>
<h1>Unraid Duplicate File Handler</h1>
<div class="scan-container">
    <!-- Left Column: Form and Progress Bar -->
    <div class="left-column">
        <form method="post">
            {{ form.hidden_tag() }}
            <div>
                <label for="source_choice">{{ form.source_choice.label.text }}</label>
                {{ form.source_choice(class="form-control", id="source_choice", onchange="updateDrives()") }}
            </div>
            <div>
                <label for="drives">{{ form.drives.label.text }}</label>
                <div id="drives"></div>
            </div>
            <div>
                <label for="min_size">{{ form.min_size.label.text }}</label>
                {{ form.min_size(class="form-control", id="min_size") }}
            </div>
            <div>
                <label for="ext_filter">{{ form.ext_filter.label.text }}</label>
                {{ form.ext_filter(class="form-control", id="ext_filter") }}
            </div>
            <div>
                <label for="keep_strategy">{{ form.keep_strategy.label.text }}</label>
                {{ form.keep_strategy(class="form-control", id="keep_strategy") }}
            </div>
            <div>
                {{ form.submit(class="btn btn-primary", type="submit") }}
                <button id="cancel-button" class="btn btn-secondary" style="display: none;">Cancel</button>
            </div>
        </form>

        <div id="progress-container" class="progress-container">
            <div class="progress-bar">
                <div id="progress-bar-inner" class="progress-bar-inner"></div>
            </div>
            <p id="progress-text" class="progress-text">0% Complete</p>
        </div>
    </div>

    <!-- Right Column: Summary -->
    <div class="right-column">
        <div id="scan-summary" class="scan-summary" style="display: none;">
            <h2>Scan Summary</h2>
            <p><strong>Total Duplicate Files:</strong> <span id="total-duplicates"></span></p>
            <p><strong>Total Duplicate Size:</strong> <span id="total-size"></span></p>
            <p><strong>Time Taken:</strong> <span id="time-taken"></span></p>
            <p><strong>Time Completed:</strong> <span id="time-completed"></span></p>

            <!-- Drive Summary Section -->
            <div id="drive-summary-container" class="drive-summary" style="margin-top: 20px;">
                <h3>Drive Summary</h3>
                <table id="drive-summary-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 8px;">Drive</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Number of Duplicate Files</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Total Duplicate Size</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Drive summary rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

