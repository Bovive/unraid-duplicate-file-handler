{% extends "base.html" %}

{% block title %}Scan for Duplicates{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/scan.css') }}">
<script>
    let isScanning = false;

    function updateDrives() {
        const sourceChoice = document.getElementById("source_choice").value;
        const drivesField = document.getElementById("drives");
        drivesField.innerHTML = "";
        fetch(`/get_drives/${sourceChoice}`)
            .then(response => response.json())
            .then(data => {
                data.drives.forEach(drive => {
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.name = "drives";
                    checkbox.value = drive;
                    checkbox.id = `drive-${drive}`;

                    const label = document.createElement("label");
                    label.htmlFor = `drive-${drive}`;
                    label.textContent = drive;

                    const container = document.createElement("div");
                    container.className = "form-check"; // Ensure the class is applied for styling
                    container.appendChild(label); // Append the label first
                    container.appendChild(checkbox); // Append the checkbox second

                    drivesField.appendChild(container);
                });
            })
            .catch(error => console.error("Error fetching drives:", error));
    }

    function startProgress() {
        const progressContainer = document.getElementById("progress-container");
        const progressBarInner = document.getElementById("progress-bar-inner");
        const progressText = document.getElementById("progress-text");
        const submitButton = document.querySelector(".btn.btn-primary");

        // Disable the button and set scanning state
        isScanning = true;
        submitButton.disabled = true;

        // Reset progress bar and text
        progressBarInner.style.width = "0%";
        progressText.textContent = "0% Complete";
        progressContainer.style.display = "block";

        function updateProgress() {
            fetch("/progress")
                .then(response => response.json())
                .then(data => {
                    const progress = data.progress;
                    progressBarInner.style.width = progress + "%";
                    progressText.textContent = progress + "% Complete";
                    if (progress < 100) {
                        setTimeout(updateProgress, 500);
                    } else {
                        fetchSummary(); // Fetch the summary after completion
                    }
                });
        }

        function fetchSummary() {
            fetch("/scan-summary")
                .then(response => {
                    if (response.status === 202) {
                        // Retry if scan is not yet complete
                        setTimeout(fetchSummary, 500);
                    } else if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("Failed to fetch scan summary.");
                    }
                })
                .then(summary => {
                    if (summary) {
                        console.log("Scan summary fetched:", summary); // Debug log
                        updateSummary(summary);
                        isScanning = false; // Reset scanning state
                        submitButton.disabled = false; // Re-enable the button
                    }
                })
                .catch(error => {
                    console.error("Error fetching scan summary:", error);
                    isScanning = false; // Reset scanning state on error
                    submitButton.disabled = false; // Re-enable the button
                });
        }

        updateProgress();
    }

    function updateSummary(summary) {
        const summaryContainer = document.getElementById("scan-summary");
        summaryContainer.style.display = "block";

        // Display formatted values directly from the backend
        document.getElementById("total-duplicates").textContent = summary.total_duplicates || "0";
        document.getElementById("total-size").textContent = summary.total_duplicate_size || "0.00 MB";
        document.getElementById("time-taken").textContent = summary.time_taken
            ? summary.time_taken.toFixed(2) + " seconds"
            : "N/A";
        document.getElementById("time-completed").textContent = summary.time_completed || "N/A";
    }

    document.addEventListener("DOMContentLoaded", () => {
        updateDrives();
        const form = document.querySelector("form");
        form.addEventListener("submit", (event) => {
            event.preventDefault();
            if (isScanning) {
                return; // Prevent multiple submissions
            }
            startProgress();
            const formData = new FormData(form);
            fetch("/start_scan", {
                method: "POST",
                body: formData
            }).then(response => {
                if (!response.ok) {
                    console.error("Failed to start scan.");
                    isScanning = false; // Reset scanning state on failure
                    document.querySelector(".btn.btn-primary").disabled = false;
                }
            }).catch(error => {
                console.error("Error starting scan:", error);
                isScanning = false; // Reset scanning state on error
                document.querySelector(".btn.btn-primary").disabled = false;
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<a href="/" class="back-button">Back to Main Menu</a>
<h1>Unraid Duplicate File Handler</h1>
<div class="scan-container">
    <!-- Left Column: Form and Progress Bar -->
    <div class="left-column">
        <form method="post">
            {{ form.hidden_tag() }}
            <div>
                <label for="source_choice">{{ form.source_choice.label.text }}</label>
                {{ form.source_choice(class="form-control", id="source_choice", onchange="updateDrives()") }}
            </div>
            <div>
                <label for="drives">{{ form.drives.label.text }}</label>
                <div id="drives"></div>
            </div>
            <div>
                <label for="min_size">{{ form.min_size.label.text }}</label>
                {{ form.min_size(class="form-control", id="min_size") }}
            </div>
            <div>
                <label for="ext_filter">{{ form.ext_filter.label.text }}</label>
                {{ form.ext_filter(class="form-control", id="ext_filter") }}
            </div>
            <div>
                <label for="keep_strategy">{{ form.keep_strategy.label.text }}</label>
                {{ form.keep_strategy(class="form-control", id="keep_strategy") }}
            </div>
            <div>
                {{ form.submit(class="btn btn-primary", type="submit") }}
            </div>
        </form>

        <div id="progress-container" class="progress-container">
            <div class="progress-bar">
                <div id="progress-bar-inner" class="progress-bar-inner"></div>
            </div>
            <p id="progress-text" class="progress-text">0% Complete</p>
        </div>
    </div>

    <!-- Right Column: Summary -->
    <div class="right-column">
        <div id="scan-summary" class="scan-summary" style="display: none;">
            <h2>Scan Summary</h2>
            <p><strong>Total Duplicate Files:</strong> <span id="total-duplicates"></span></p>
            <p><strong>Total Duplicate Size:</strong> <span id="total-size"></span></p>
            <p><strong>Time Taken:</strong> <span id="time-taken"></span></p>
            <p><strong>Time Completed:</strong> <span id="time-completed"></span></p>
        </div>
    </div>
</div>
{% endblock %}
