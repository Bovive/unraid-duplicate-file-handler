{% extends "base.html" %}

{% block title %}Scan for Duplicates{% endblock %}

{% block head %}
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background-color: #f4f4f4;
    }
    h1 {
        color: #333;
    }
    form {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        max-width: 600px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .back-button {
        margin-top: 1.5rem;
        padding: 0.75rem 1.5rem;
        background-color: #f44336;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }
    .back-button:hover {
        background-color: #d32f2f;
    }
    .result {
        margin-top: 2rem;
        background: #e8f5e9;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .result h2 {
        color: #2e7d32;
    }
    .result p {
        margin: 0.5rem 0;
    }
    .result a {
        display: inline-block;
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background-color: #4CAF50;
        color: white;
        text-decoration: none;
        border-radius: 5px;
    }
    .result a:hover {
        background-color: #45a049;
    }
    .progress-container {
        margin-top: 2rem;
        display: none;
    }
    .progress-bar {
        width: 100%;
        background-color: #f3f3f3;
        border-radius: 5px;
        overflow: hidden;
    }
    .progress-bar-inner {
        height: 20px;
        width: 0%;
        background-color: #4CAF50;
        border-radius: 5px;
        transition: width 0.2s ease;
    }
    .progress-text {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #333;
    }
</style>
<script>
    function updateDrives() {
        const sourceChoice = document.getElementById("source_choice").value;
        const drivesField = document.getElementById("drives");
        drivesField.innerHTML = "";
        fetch(`/get_drives/${sourceChoice}`)
            .then(response => response.json())
            .then(data => {
                data.drives.forEach(drive => {
                    const option = document.createElement("option");
                    option.value = drive;
                    option.textContent = drive;
                    drivesField.appendChild(option);
                });
            })
            .catch(error => console.error("Error fetching drives:", error));
    }

    function startProgress() {
        const progressContainer = document.getElementById("progress-container");
        const progressBarInner = document.getElementById("progress-bar-inner");
        const progressText = document.getElementById("progress-text");
        progressContainer.style.display = "block";
        function updateProgress() {
            fetch("/progress")
                .then(response => response.json())
                .then(data => {
                    const progress = data.progress;
                    progressBarInner.style.width = progress + "%";
                    progressText.textContent = progress + "% Complete";
                    if (progress < 100) {
                        setTimeout(updateProgress, 500);
                    }
                });
        }
        updateProgress();
    }

    document.addEventListener("DOMContentLoaded", () => {
        updateDrives();
        const form = document.querySelector("form");
        form.addEventListener("submit", (event) => {
            event.preventDefault();
            startProgress();
            const formData = new FormData(form);
            fetch("/start_scan", {
                method: "POST",
                body: formData
            }).then(response => {
                if (!response.ok) {
                    console.error("Failed to start scan.");
                }
            }).catch(error => {
                console.error("Error starting scan:", error);
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<h1>Unraid Duplicate File Handler</h1>
<form method="post">
    {{ form.hidden_tag() }}
    <div>
        <label for="source_choice">{{ form.source_choice.label.text }}</label>
        {{ form.source_choice(class="form-control", id="source_choice", onchange="updateDrives()") }}
    </div>
    <div>
        <label for="drives">{{ form.drives.label.text }}</label>
        {{ form.drives(class="form-control", id="drives") }}
    </div>
    <div>
        <label for="min_size">{{ form.min_size.label.text }}</label>
        {{ form.min_size(class="form-control", id="min_size") }}
    </div>
    <div>
        <label for="ext_filter">{{ form.ext_filter.label.text }}</label>
        {{ form.ext_filter(class="form-control", id="ext_filter") }}
    </div>
    <div>
        <label for="keep_strategy">{{ form.keep_strategy.label.text }}</label>
        {{ form.keep_strategy(class="form-control", id="keep_strategy") }}
    </div>
    <div>
        {{ form.submit(class="btn btn-primary") }}
    </div>
</form>

<div id="progress-container" class="progress-container">
    <div class="progress-bar">
        <div id="progress-bar-inner" class="progress-bar-inner"></div>
    </div>
    <p id="progress-text" class="progress-text">0% Complete</p>
</div>

<a href="/" class="back-button">Back to Main Menu</a>
{% endblock %}
